<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>The Last Transmission — A Planespace Game</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Crimson+Text:ital,wght@0,400;0,600;1,400&family=JetBrains+Mono:wght@400;500&display=swap" rel="stylesheet">
  <style>
    *, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }

    html, body {
      width: 100%; height: 100%;
      background: #000;
      overflow: hidden;
      font-family: 'Crimson Text', Georgia, serif;
    }

    #game {
      width: 100vw;
      height: 100vh;
      position: relative;
      overflow: hidden;
    }

    /* ── TITLE SCENE ── */
    .title-bg {
      background: radial-gradient(ellipse 80% 80% at 50% 60%, #0d0818 0%, #050308 100%);
    }
    .title-rain {
      position: absolute; inset: 0;
      background-image: repeating-linear-gradient(
        180deg,
        transparent 0px,
        transparent 8px,
        rgba(120,140,180,0.04) 8px,
        rgba(120,140,180,0.04) 9px
      );
      animation: rain-fall 0.6s linear infinite;
    }
    @keyframes rain-fall {
      from { background-position: 0 0; }
      to   { background-position: 0 60px; }
    }
    .title-city {
      position: absolute;
      bottom: 0; left: 0; right: 0;
      height: 45vh;
      background:
        /* Buildings silhouette */
        linear-gradient(to top, #07050d 0%, transparent 100%),
        repeating-linear-gradient(
          90deg,
          transparent 0%,
          transparent 5%,
          rgba(10,8,20,0.9) 5%,
          rgba(10,8,20,0.9) 12%,
          transparent 12%
        );
    }
    .title-glow {
      position: absolute;
      bottom: 35%;
      left: 50%;
      transform: translateX(-50%);
      width: 500px; height: 200px;
      background: radial-gradient(ellipse, rgba(180,80,20,0.15) 0%, transparent 70%);
      filter: blur(20px);
    }
    .title-text {
      position: absolute;
      top: 50%; left: 50%;
      transform: translate(-50%, -50%) translateY(-40px);
      text-align: center;
      width: 90%;
    }
    .title-eyebrow {
      font-family: 'JetBrains Mono', monospace;
      font-size: 0.65rem;
      letter-spacing: 0.4em;
      text-transform: uppercase;
      color: rgba(180,140,80,0.7);
      margin-bottom: 18px;
    }
    .title-main {
      font-size: clamp(2.8rem, 7vw, 5.5rem);
      font-weight: 600;
      line-height: 1.05;
      color: #e8dcc8;
      letter-spacing: -0.01em;
      text-shadow: 0 0 80px rgba(180,80,20,0.3);
      margin-bottom: 16px;
    }
    .title-sub {
      font-size: 1.1rem;
      font-style: italic;
      color: rgba(200,185,155,0.5);
      letter-spacing: 0.05em;
    }
    .title-prompt {
      position: absolute;
      bottom: 12%; left: 50%;
      transform: translateX(-50%);
      font-family: 'JetBrains Mono', monospace;
      font-size: 0.7rem;
      letter-spacing: 0.22em;
      text-transform: uppercase;
      color: rgba(180,140,80,0.6);
      cursor: pointer;
      animation: pulse-opacity 2s ease-in-out infinite;
    }
    @keyframes pulse-opacity {
      0%,100% { opacity: 0.6; }
      50% { opacity: 1; }
    }

    /* ── HARBOR SCENE ── */
    .harbor-sky {
      background: linear-gradient(
        180deg,
        #060a12 0%,
        #0c1220 40%,
        #111828 100%
      );
    }
    .harbor-rain {
      position: absolute; inset: 0;
      overflow: hidden;
    }
    .harbor-rain::before {
      content: '';
      position: absolute; inset: -50%;
      background: repeating-linear-gradient(
        175deg,
        transparent 0,
        transparent 4px,
        rgba(150,170,210,0.06) 4px,
        rgba(150,170,210,0.06) 5px
      );
      animation: rain-diag 0.4s linear infinite;
    }
    @keyframes rain-diag {
      from { transform: translateY(-60px); }
      to   { transform: translateY(60px); }
    }
    .moon {
      position: absolute;
      top: 12%; right: 22%;
      width: 50px; height: 50px;
      border-radius: 50%;
      background: radial-gradient(circle at 42% 38%, #e8dcc0 0%, #a8905a 60%, #5a4020 100%);
      box-shadow: 0 0 40px rgba(200,170,100,0.25), 0 0 100px rgba(200,170,100,0.08);
    }
    .moon-clouds {
      position: absolute;
      top: 8%; left: 0; right: 0;
      height: 30%;
      background:
        radial-gradient(ellipse 40% 60% at 25% 40%, rgba(20,28,45,0.8) 0%, transparent 100%),
        radial-gradient(ellipse 50% 70% at 75% 30%, rgba(15,22,38,0.7) 0%, transparent 100%);
    }
    .city-far {
      position: absolute;
      bottom: 42%;
      left: 0; right: 0;
      height: 25%;
    }
    .city-far::before {
      content: '';
      position: absolute;
      inset: 0;
      background:
        /* Building silhouettes far */
        linear-gradient(to top, #0c1420 0%, transparent 100%);
      clip-path: polygon(
        0% 100%, 0% 65%,
        4% 65%, 4% 45%,
        7% 45%, 7% 60%,
        12% 60%, 12% 35%,
        15% 35%, 15% 55%,
        20% 55%, 20% 40%,
        24% 40%, 24% 60%,
        28% 60%, 28% 25%,
        31% 25%, 31% 50%,
        36% 50%, 36% 38%,
        40% 38%, 40% 55%,
        45% 55%, 45% 30%,
        49% 30%, 49% 50%,
        55% 50%, 55% 42%,
        60% 42%, 60% 62%,
        65% 62%, 65% 35%,
        70% 35%, 70% 55%,
        76% 55%, 76% 40%,
        82% 40%, 82% 60%,
        88% 60%, 88% 32%,
        91% 32%, 91% 58%,
        95% 58%, 95% 45%,
        100% 45%, 100% 100%
      );
    }
    .city-lights-far {
      position: absolute;
      bottom: 42%; left: 0; right: 0;
      height: 25%;
      background: radial-gradient(ellipse 80% 60% at 50% 80%, rgba(255,180,80,0.06) 0%, transparent 100%);
    }
    .water {
      position: absolute;
      bottom: 0; left: 0; right: 0;
      height: 42%;
      background: linear-gradient(
        180deg,
        #0c1828 0%,
        #08101e 40%,
        #060c18 100%
      );
      overflow: hidden;
    }
    .water::after {
      content: '';
      position: absolute;
      inset: 0;
      background: repeating-linear-gradient(
        0deg,
        transparent 0px,
        transparent 6px,
        rgba(255,255,255,0.015) 6px,
        rgba(255,255,255,0.015) 7px
      );
    }
    .water-reflection {
      position: absolute;
      top: 5%; left: 20%; right: 20%;
      height: 40%;
      background: linear-gradient(180deg, rgba(255,180,80,0.08) 0%, transparent 100%);
      filter: blur(8px);
    }
    .dock {
      position: absolute;
      bottom: 38%;
      left: 5%; right: 55%;
      height: 6px;
      background: #1a1410;
      box-shadow: 0 0 20px rgba(0,0,0,0.8);
    }
    .dock-posts {
      position: absolute;
      bottom: 38%; left: 5%;
      display: flex; gap: 40px;
    }
    .dock-post {
      width: 6px; height: 28px;
      background: #1a1410;
      border-radius: 2px;
    }
    .ship {
      position: absolute;
      bottom: 38%; right: 8%;
    }
    .ship-hull {
      width: 280px; height: 55px;
      background: linear-gradient(180deg, #1a1510 0%, #100e08 100%);
      border-radius: 4px 4px 30px 30px;
      position: relative;
    }
    .ship-cabin {
      position: absolute;
      bottom: 100%; right: 20px;
      width: 120px; height: 50px;
      background: #141210;
      border-radius: 3px 3px 0 0;
    }
    .ship-window {
      width: 12px; height: 12px;
      background: radial-gradient(circle, rgba(255,200,100,0.9), rgba(200,140,40,0.5));
      border-radius: 50%;
      position: absolute;
      box-shadow: 0 0 12px rgba(255,180,60,0.6);
    }
    .ship-window-1 { top: 14px; left: 18px; }
    .ship-window-2 { top: 14px; left: 42px; }
    .ship-chimney {
      position: absolute;
      bottom: calc(100% + 50px); right: 50px;
      width: 14px; height: 35px;
      background: #0e0c0a;
      border-radius: 2px 2px 0 0;
    }
    .ship-chimney::after {
      content: '';
      position: absolute;
      bottom: 100%; left: 50%;
      transform: translateX(-50%);
      width: 30px; height: 30px;
      background: radial-gradient(circle, rgba(40,40,50,0.6) 0%, transparent 100%);
      border-radius: 50%;
      animation: smoke 3s ease-in-out infinite;
    }
    @keyframes smoke {
      0%   { opacity: 0.6; transform: translateX(-50%) translateY(0) scale(1); }
      100% { opacity: 0; transform: translateX(-60%) translateY(-40px) scale(2.5); }
    }
    .lamp-post {
      position: absolute;
      bottom: 38%; left: 25%;
    }
    .lamp-pole { width: 4px; height: 80px; background: #1a1510; }
    .lamp-head {
      width: 20px; height: 10px;
      background: #1a1510;
      margin-left: -8px;
      position: relative;
    }
    .lamp-glow {
      position: absolute;
      bottom: -4px; left: 50%; transform: translateX(-50%);
      width: 8px; height: 8px;
      background: rgba(255,200,80,0.9);
      border-radius: 50%;
      box-shadow: 0 0 20px 8px rgba(255,180,60,0.4), 0 0 60px 20px rgba(255,180,60,0.15);
    }

    /* ── CABIN SCENE ── */
    .cabin-walls {
      background: #0d0b08;
    }
    .cabin-wall-texture {
      position: absolute; inset: 0;
      background:
        repeating-linear-gradient(90deg, rgba(255,255,255,0.01) 0, rgba(255,255,255,0.01) 1px, transparent 1px, transparent 40px),
        repeating-linear-gradient(0deg, rgba(255,255,255,0.008) 0, rgba(255,255,255,0.008) 1px, transparent 1px, transparent 40px);
    }
    .porthole {
      position: absolute;
      top: 20%; right: 15%;
      width: 100px; height: 100px;
      border-radius: 50%;
      border: 8px solid #1a1510;
      overflow: hidden;
      box-shadow: inset 0 0 20px rgba(0,0,0,0.8), 0 0 0 4px #0d0b08;
    }
    .porthole-view {
      width: 100%; height: 100%;
      background: radial-gradient(circle at 40% 35%, #1a2840 0%, #0a1020 100%);
      position: relative;
      overflow: hidden;
    }
    .porthole-rain {
      position: absolute; inset: 0;
      background: repeating-linear-gradient(175deg, transparent 0, transparent 3px, rgba(150,170,210,0.15) 3px, rgba(150,170,210,0.15) 4px);
      animation: rain-diag 0.4s linear infinite;
    }
    .cabin-table {
      position: absolute;
      bottom: 15%; left: 50%; right: 0;
      height: 35%;
      background: linear-gradient(180deg, #1a1408 0%, #120f06 100%);
      border-top: 2px solid #2a2015;
      border-radius: 4px 0 0 0;
    }
    .cabin-table-edge {
      position: absolute;
      bottom: 15%; left: 0; right: 0;
      height: 3px;
      background: linear-gradient(90deg, #0d0b08 0%, #1a1408 50%, #0d0b08 100%);
    }
    .floor-boards {
      position: absolute;
      bottom: 0; left: 0; right: 0;
      height: 15%;
      background:
        repeating-linear-gradient(90deg, #0a0806 0, #0a0806 60px, #0c0a07 60px, #0c0a07 61px);
    }
    .overhead-lamp {
      position: absolute;
      top: 0; left: 42%;
    }
    .lamp-wire {
      width: 2px; height: 40px;
      background: #1a1510;
      margin: 0 auto;
    }
    .lamp-shade {
      width: 50px; height: 25px;
      background: linear-gradient(180deg, #1a1510 0%, #0d0b08 100%);
      clip-path: polygon(10% 0%, 90% 0%, 100% 100%, 0% 100%);
    }
    .lamp-cone {
      position: absolute;
      top: 65px; left: -80px;
      width: 210px; height: 180px;
      background: radial-gradient(ellipse at 50% 0%, rgba(255,200,100,0.18) 0%, transparent 70%);
      pointer-events: none;
    }
    .radio {
      position: absolute;
      bottom: 22%; right: 22%;
      width: 80px; height: 55px;
      background: linear-gradient(180deg, #1e1a10 0%, #141008 100%);
      border-radius: 4px;
      border: 1px solid #2a2215;
      box-shadow: 0 4px 20px rgba(0,0,0,0.6);
    }
    .radio-dial {
      width: 18px; height: 18px;
      border-radius: 50%;
      background: radial-gradient(circle at 40% 35%, #3a3020, #1a1510);
      border: 2px solid #2a2015;
      position: absolute;
      top: 10px; left: 10px;
    }
    .radio-screen {
      position: absolute;
      top: 8px; right: 8px;
      width: 30px; height: 20px;
      background: rgba(0,255,100,0.08);
      border: 1px solid rgba(0,255,100,0.15);
      border-radius: 2px;
      animation: screen-flicker 3s ease-in-out infinite;
    }
    @keyframes screen-flicker {
      0%,100% { opacity: 1; }
      92% { opacity: 1; }
      93% { opacity: 0.5; }
      94% { opacity: 1; }
    }
    .radio-speaker {
      position: absolute;
      bottom: 8px; left: 6px; right: 6px;
      height: 14px;
      border-top: 1px solid #2a2015;
      background: repeating-linear-gradient(90deg, transparent 0, transparent 3px, rgba(255,255,255,0.05) 3px, rgba(255,255,255,0.05) 4px);
    }
    .log-book {
      position: absolute;
      bottom: 26%; left: 55%;
      width: 100px; height: 70px;
      background: linear-gradient(135deg, #1e1a0e 0%, #161208 100%);
      border-radius: 2px;
      border: 1px solid #2a2215;
      transform: rotate(-3deg);
    }
    .log-book::after {
      content: '';
      position: absolute;
      top: 10px; left: 8px; right: 8px;
      height: 2px;
      background: rgba(255,255,255,0.06);
      box-shadow: 0 8px 0 rgba(255,255,255,0.04), 0 16px 0 rgba(255,255,255,0.04);
    }
    .map-paper {
      position: absolute;
      bottom: 40%; left: 60%;
      width: 140px; height: 100px;
      background: linear-gradient(135deg, #1e1c10 0%, #181408 100%);
      border-radius: 2px;
      border: 1px solid #2a2215;
      transform: rotate(5deg);
      overflow: hidden;
    }
    .map-paper::before {
      content: '';
      position: absolute; inset: 8px;
      border: 1px dashed rgba(255,255,255,0.06);
    }
    .interactable-hint {
      position: absolute;
      top: 0; left: 0; right: 0; bottom: 0;
      border-radius: inherit;
      transition: box-shadow 0.2s;
    }
    .interactable-hint:hover {
      box-shadow: 0 0 0 2px rgba(180,140,60,0.4), 0 0 20px rgba(180,140,60,0.15);
    }
    .item-glow {
      animation: item-pulse 2.5s ease-in-out infinite;
    }
    @keyframes item-pulse {
      0%,100% { box-shadow: 0 0 0 1px rgba(180,140,60,0.2); }
      50% { box-shadow: 0 0 0 2px rgba(180,140,60,0.4), 0 0 20px rgba(180,140,60,0.15); }
    }

    /* ── RADIO ROOM ── */
    .radioroom-walls {
      background: linear-gradient(180deg, #080609 0%, #0a0810 100%);
    }
    .console-back {
      position: absolute;
      bottom: 20%; left: 0; right: 0;
      height: 50%;
      background: linear-gradient(180deg, #0e0c14 0%, #0a0810 100%);
      border-top: 2px solid #1a1828;
    }
    .console-panels {
      position: absolute;
      bottom: 20%; left: 5%; right: 5%;
      height: 45%;
      display: grid;
      grid-template-columns: repeat(4, 1fr);
      gap: 8px;
      padding: 12px;
    }
    .console-panel {
      background: linear-gradient(180deg, #121020 0%, #0e0c18 100%);
      border: 1px solid #1e1c2c;
      border-radius: 4px;
      display: flex; flex-direction: column;
      align-items: center;
      justify-content: center;
      gap: 6px;
      padding: 8px;
    }
    .panel-indicator {
      width: 8px; height: 8px;
      border-radius: 50%;
    }
    .ind-red    { background: #f87171; box-shadow: 0 0 8px rgba(248,113,113,0.6); }
    .ind-green  { background: #4ade80; box-shadow: 0 0 8px rgba(74,222,128,0.6); animation: blink 1.5s ease-in-out infinite; }
    .ind-amber  { background: #fbbf24; box-shadow: 0 0 8px rgba(251,191,36,0.5); }
    .ind-blue   { background: #60a5fa; box-shadow: 0 0 8px rgba(96,165,250,0.5); }
    .ind-off    { background: #1a1828; box-shadow: none; }
    @keyframes blink { 0%,100%{opacity:1;} 50%{opacity:0.3;} }
    .panel-label {
      font-family: 'JetBrains Mono', monospace;
      font-size: 0.5rem;
      color: rgba(200,200,220,0.3);
      letter-spacing: 0.1em;
      text-transform: uppercase;
    }
    .panel-knob {
      width: 18px; height: 18px;
      border-radius: 50%;
      background: radial-gradient(circle at 40% 35%, #2a2838, #141220);
      border: 1px solid #2a2838;
    }
    .main-transmitter {
      position: absolute;
      bottom: 62%; left: 50%;
      transform: translateX(-50%);
      width: 220px; height: 140px;
      background: linear-gradient(180deg, #161428 0%, #100e20 100%);
      border: 2px solid #2a2840;
      border-radius: 8px;
      box-shadow: 0 0 60px rgba(100,80,200,0.1), 0 0 0 1px rgba(100,80,200,0.08);
    }
    .transmitter-screen {
      position: absolute;
      top: 12px; left: 12px; right: 12px;
      height: 60px;
      background: #030308;
      border: 1px solid rgba(100,80,200,0.2);
      border-radius: 4px;
      overflow: hidden;
    }
    .screen-scan {
      position: absolute;
      top: 0; left: 0;
      width: 100%; height: 2px;
      background: rgba(100,200,100,0.5);
      animation: scan-line 2s linear infinite;
      box-shadow: 0 0 8px rgba(100,200,100,0.4);
    }
    @keyframes scan-line {
      0%   { top: 0%; opacity: 1; }
      90%  { opacity: 1; }
      100% { top: 100%; opacity: 0; }
    }
    .screen-data {
      position: absolute;
      inset: 6px;
      font-family: 'JetBrains Mono', monospace;
      font-size: 0.48rem;
      color: rgba(100,220,100,0.6);
      line-height: 1.6;
      letter-spacing: 0.08em;
    }
    .transmitter-dials {
      position: absolute;
      bottom: 10px; left: 0; right: 0;
      display: flex;
      justify-content: space-around;
      padding: 0 14px;
    }
    .big-dial {
      width: 28px; height: 28px;
      border-radius: 50%;
      background: radial-gradient(circle at 40% 35%, #2a2840, #161428);
      border: 2px solid #3a3850;
      position: relative;
    }
    .big-dial::after {
      content: '';
      position: absolute;
      top: 3px; left: 50%;
      transform: translateX(-50%);
      width: 2px; height: 8px;
      background: rgba(255,255,255,0.4);
      border-radius: 1px;
    }
    .frequency-bar {
      position: absolute;
      bottom: 8px; left: 0; right: 0;
      display: flex;
      justify-content: center;
      gap: 3px;
      padding: 0 20px;
    }
    .freq-bar {
      width: 4px;
      background: rgba(100,80,200,0.4);
      border-radius: 1px;
      animation: freq-anim 1.2s ease-in-out infinite;
    }
    @keyframes freq-anim {
      0%,100% { height: 4px; }
      50% { height: 18px; background: rgba(100,200,100,0.6); }
    }
    .floor-glow {
      position: absolute;
      bottom: 18%; left: 50%;
      transform: translateX(-50%);
      width: 400px; height: 80px;
      background: radial-gradient(ellipse, rgba(80,60,180,0.12) 0%, transparent 70%);
      filter: blur(10px);
    }
    .exit-ladder {
      position: absolute;
      bottom: 20%; right: 8%;
      width: 40px;
    }
    .ladder-rail {
      position: absolute;
      bottom: 0; height: 120px; width: 4px;
      background: #1a1828;
      border-radius: 2px;
    }
    .ladder-rail-l { left: 2px; }
    .ladder-rail-r { right: 2px; }
    .ladder-rung {
      position: absolute;
      left: 2px; right: 2px; height: 3px;
      background: #1a1828; border-radius: 1px;
    }

    /* ── END SCENE ── */
    .end-bg {
      background: radial-gradient(ellipse 60% 60% at 50% 50%, #0a0818 0%, #040308 100%);
    }
    .end-stars {
      position: absolute; inset: 0;
      background-image:
        radial-gradient(1px 1px at 15% 25%, rgba(255,255,255,0.6) 0%, transparent 1px),
        radial-gradient(1px 1px at 45% 12%, rgba(255,255,255,0.5) 0%, transparent 1px),
        radial-gradient(1.5px 1.5px at 72% 18%, rgba(200,180,255,0.7) 0%, transparent 1px),
        radial-gradient(1px 1px at 88% 30%, rgba(255,255,255,0.4) 0%, transparent 1px),
        radial-gradient(1px 1px at 30% 55%, rgba(255,255,255,0.5) 0%, transparent 1px),
        radial-gradient(1px 1px at 60% 68%, rgba(200,180,255,0.4) 0%, transparent 1px),
        radial-gradient(1px 1px at 20% 78%, rgba(255,255,255,0.3) 0%, transparent 1px),
        radial-gradient(2px 2px at 50% 40%, rgba(200,180,255,0.8) 0%, transparent 1px);
    }
    .end-text {
      position: absolute;
      top: 50%; left: 50%;
      transform: translate(-50%,-50%);
      text-align: center;
    }
    .end-title {
      font-size: clamp(1.4rem, 4vw, 2.4rem);
      font-style: italic;
      color: rgba(200,185,155,0.9);
      margin-bottom: 16px;
    }
    .end-sub {
      font-family: 'JetBrains Mono', monospace;
      font-size: 0.68rem;
      letter-spacing: 0.2em;
      text-transform: uppercase;
      color: rgba(180,140,80,0.5);
      margin-bottom: 32px;
    }
    .end-restart {
      font-family: 'JetBrains Mono', monospace;
      font-size: 0.72rem;
      letter-spacing: 0.2em;
      text-transform: uppercase;
      color: rgba(180,140,80,0.5);
      cursor: pointer;
      border: 1px solid rgba(180,140,80,0.2);
      padding: 10px 24px;
      border-radius: 4px;
      display: inline-block;
      transition: all 0.2s;
    }
    .end-restart:hover {
      color: rgba(200,170,100,0.9);
      border-color: rgba(200,170,100,0.4);
      background: rgba(200,170,100,0.05);
    }

    /* ── Interactable hover ── */
    [data-clickable]:hover { outline: 1px solid rgba(200,160,60,0.35); }
  </style>
</head>
<body>
  <div id="game"></div>

  <script type="module">

  // ════════════════════════════════════════════════════════════════════════════
  //  PLANESPACE GAME ENGINE — embedded self-contained version
  // ════════════════════════════════════════════════════════════════════════════

  class ParallaxEngine {
    constructor(root, opts = {}) {
      this.root = root;
      this.maxAngle = opts.maxAngle || 5;
      this.lerp = opts.lerpFactor || 0.055;
      this.perspective = opts.perspective || 1100;
      this.rx = this.ry = this.tx = this.ty = 0;
      this._bound = this._move.bind(this);
    }
    mount() {
      this.root.style.perspective = `${this.perspective}px`;
      this.root.style.transformStyle = 'preserve-3d';
      this._applyZ();
      window.addEventListener('mousemove', this._bound, { passive: true });
      this._tick();
    }
    _applyZ() {
      for (const el of this.root.querySelectorAll('[data-z]')) {
        el.style.transform = `translateZ(${el.getAttribute('data-z')}px)`;
        el.style.transformStyle = 'preserve-3d';
      }
    }
    refresh() { this._applyZ(); }
    _move(e) {
      this.tx = (e.clientX / window.innerWidth)  * 2 - 1;
      this.ty = (e.clientY / window.innerHeight) * 2 - 1;
    }
    _tick() {
      this.rx += (this.tx - this.rx) * this.lerp;
      this.ry += (this.ty - this.ry) * this.lerp;
      this.root.style.transform =
        `perspective(${this.perspective}px) rotateY(${this.rx * this.maxAngle}deg) rotateX(${-this.ry * this.maxAngle}deg)`;
      requestAnimationFrame(this._tick.bind(this));
    }
  }

  class GameState {
    #d = {};
    get(k)       { return this.#d[k]; }
    set(k, v)    { this.#d[k] = v; return this; }
    has(k)       { return k in this.#d; }
    toggle(k)    { this.#d[k] = !this.#d[k]; return this; }
  }

  class Dialogue {
    constructor(container, theme = {}) {
      this.theme = theme;
      this._box = this._build(container);
      this._inner = this._box.querySelector('.dlg-inner');
      this._name  = this._box.querySelector('.dlg-name');
      this._text  = this._box.querySelector('.dlg-text');
      this._prompt= this._box.querySelector('.dlg-prompt');
      this._choices=this._box.querySelector('.dlg-choices');
    }
    _build(c) {
      const b = document.createElement('div');
      b.innerHTML = `
        <div class="dlg-inner">
          <div class="dlg-name"></div>
          <div class="dlg-text"></div>
          <div class="dlg-choices"></div>
          <div class="dlg-prompt">▸ click to continue</div>
        </div>`;
      b.style.cssText = `
        position:fixed;bottom:0;left:0;right:0;
        padding:0 6% 28px;z-index:1000;
        pointer-events:none;opacity:0;
        transform:translateY(10px);
        transition:opacity .22s ease,transform .22s ease;`;
      b.querySelector('.dlg-inner').style.cssText = `
        background:rgba(6,4,12,0.93);
        border:1px solid rgba(255,255,255,0.1);
        border-radius:10px;padding:18px 26px 20px;
        backdrop-filter:blur(16px);
        max-width:800px;margin:0 auto;
        pointer-events:all;cursor:pointer;
        box-shadow:0 -6px 40px rgba(0,0,0,0.6);`;
      b.querySelector('.dlg-name').style.cssText = `
        font-family:'JetBrains Mono',monospace;
        font-size:.7rem;letter-spacing:.18em;
        text-transform:uppercase;color:#c9a84c;
        margin-bottom:7px;min-height:1em;`;
      b.querySelector('.dlg-text').style.cssText = `
        font-family:'Crimson Text',Georgia,serif;
        font-size:1.08rem;line-height:1.68;color:#e0d8c4;`;
      b.querySelector('.dlg-choices').style.cssText = `
        display:flex;flex-direction:column;gap:7px;margin-top:12px;`;
      b.querySelector('.dlg-prompt').style.cssText = `
        font-family:'JetBrains Mono',monospace;font-size:.6rem;
        color:rgba(180,155,100,.4);text-align:right;margin-top:9px;
        letter-spacing:.1em;animation:dlg-blink 1.5s ease-in-out infinite;`;
      c.appendChild(b);
      const s = document.createElement('style');
      s.textContent = `@keyframes dlg-blink{0%,100%{opacity:.4}50%{opacity:1}}`;
      document.head.appendChild(s);
      return b;
    }
    _show() {
      this._box.style.opacity = '1';
      this._box.style.transform = 'translateY(0)';
      this._box.style.pointerEvents = 'all';
    }
    _hide() {
      this._box.style.opacity = '0';
      this._box.style.transform = 'translateY(10px)';
      this._box.style.pointerEvents = 'none';
    }
    say(lines) {
      return new Promise(resolve => {
        const q = (Array.isArray(lines) ? [...lines] : [{ text: lines }]);
        const next = () => {
          if (!q.length) { this._hide(); resolve(); return; }
          const l = q.shift();
          this._name.textContent = l.speaker || '';
          this._text.textContent = l.text;
          this._choices.innerHTML = '';
          this._prompt.style.display = '';
          this._show();
          this._inner.addEventListener('click', next, { once: true });
        };
        next();
      });
    }
    choice(prompt, options) {
      return new Promise(resolve => {
        this._name.textContent = '';
        this._text.textContent = prompt;
        this._prompt.style.display = 'none';
        this._choices.innerHTML = '';
        for (const opt of options) {
          const btn = document.createElement('button');
          btn.textContent = opt.text;
          btn.style.cssText = `
            background:rgba(255,255,255,0.05);border:1px solid rgba(255,255,255,0.1);
            border-radius:5px;color:#e0d8c4;font-family:'Crimson Text',Georgia,serif;
            font-size:1rem;padding:9px 14px;text-align:left;cursor:pointer;
            transition:background .12s,border-color .12s;`;
          btn.onmouseenter = () => { btn.style.background = 'rgba(200,160,60,.12)'; btn.style.borderColor = 'rgba(200,160,60,.3)'; };
          btn.onmouseleave = () => { btn.style.background = 'rgba(255,255,255,0.05)'; btn.style.borderColor = 'rgba(255,255,255,0.1)'; };
          btn.onclick = () => { this._hide(); resolve(opt.value ?? opt.text); };
          this._choices.appendChild(btn);
        }
        this._show();
      });
    }
  }

  class Transition {
    constructor(c) {
      this._el = document.createElement('div');
      this._el.style.cssText = `
        position:fixed;inset:0;background:#000;z-index:998;
        pointer-events:none;opacity:0;transition:opacity .38s ease;`;
      c.appendChild(this._el);
    }
    async out() { this._el.style.opacity = '1'; await wait(400); }
    async in()  { this._el.style.opacity = '0'; await wait(500); }
    async flash(color = '#fff', ms = 100) {
      this._el.style.background = color;
      this._el.style.transition = `opacity ${ms}ms ease`;
      this._el.style.opacity = '.7';
      await wait(ms);
      this._el.style.transition = 'opacity .4s ease';
      this._el.style.opacity = '0';
      this._el.style.background = '#000';
      await wait(420);
    }
  }

  function wait(ms) { return new Promise(r => setTimeout(r, ms)); }

  class PlanespaceGame {
    #scenes = new Map();
    #actions = new Map();
    #state = new GameState();
    #engine; #dlg; #tr;
    #container; #sceneEl;
    #current = null;

    constructor(opts = {}) {
      this.#container = opts.container || document.body;
      this.#container.style.cssText += 'position:relative;width:100%;height:100%;overflow:hidden;';
      this.#sceneEl = document.createElement('div');
      this.#sceneEl.style.cssText = 'position:absolute;inset:0;overflow:hidden;';
      this.#container.appendChild(this.#sceneEl);
      this.#engine = new ParallaxEngine(this.#sceneEl, opts);
      this.#dlg = new Dialogue(this.#container, opts.theme || {});
      this.#tr  = new Transition(this.#container);
      this._setupCursor(opts.cursorColor || '#c9a84c');
    }

    _setupCursor(color) {
      document.body.style.cursor = 'none';
      const dot  = document.createElement('div');
      const ring = document.createElement('div');
      dot.style.cssText = `
        width:7px;height:7px;background:${color};border-radius:50%;
        position:fixed;top:0;left:0;pointer-events:none;z-index:9999;
        transform:translate(-50%,-50%);mix-blend-mode:screen;`;
      ring.style.cssText = `
        width:26px;height:26px;border:1.5px solid ${color};border-radius:50%;
        position:fixed;top:0;left:0;pointer-events:none;z-index:9998;
        transform:translate(-50%,-50%);opacity:.5;transition:transform .18s ease;`;
      document.body.append(dot, ring);
      window.addEventListener('mousemove', e => {
        dot.style.left = ring.style.left = e.clientX + 'px';
        dot.style.top  = ring.style.top  = e.clientY + 'px';
      });
    }

    scene(name, def)  { this.#scenes.set(name, def);  return this; }
    action(name, fn)  { this.#actions.set(name, fn);  return this; }

    async start(name) {
      this.#engine.mount();
      await this.#load(name, true);
    }

    async #load(name, firstLoad = false) {
      const def = this.#scenes.get(name);
      if (!def) throw new Error(`No scene: ${name}`);
      if (!firstLoad) await this.#tr.out();
      this.#sceneEl.innerHTML = '';
      (def.layers  || []).forEach(l => this.#layer(l));
      (def.objects || []).forEach(o => this.#object(o));
      this.#engine.refresh();
      this.#current = name;
      await this.#tr.in();
      if (def.onEnter) await def.onEnter(this.#state, this.#api());
    }

    #layer(l) {
      const el = document.createElement('div');
      el.setAttribute('data-z', l.z ?? 0);
      if (l.id) el.id = l.id;
      if (l.className) el.className = l.className;
      el.style.cssText = `position:absolute;inset:0;${l.style || ''}`;
      if (l.html) el.innerHTML = l.html;
      this.#sceneEl.appendChild(el);
    }

    #object(o) {
      if (o.condition && !o.condition(this.#state)) return;
      const el = document.createElement('div');
      el.setAttribute('data-z', o.z ?? 0);
      if (o.id) el.id = `obj-${o.id}`;
      el.style.cssText = `
        position:absolute;left:${o.x||'50%'};top:${o.y||'50%'};
        transform:translate(-50%,-50%);
        ${o.action ? 'cursor:pointer;' : ''}
        ${o.style || ''}`;
      if (o.html) el.innerHTML = o.html;
      if (o.label) {
        const hint = document.createElement('div');
        hint.style.cssText = `
          position:absolute;bottom:calc(100% + 8px);left:50%;
          transform:translateX(-50%);background:rgba(0,0,0,.82);
          color:#c9a84c;font-family:'JetBrains Mono',monospace;
          font-size:.62rem;letter-spacing:.12em;text-transform:uppercase;
          padding:3px 10px;border-radius:3px;white-space:nowrap;
          opacity:0;transition:opacity .15s;pointer-events:none;`;
        hint.textContent = o.label;
        el.appendChild(hint);
        el.addEventListener('mouseenter', () => hint.style.opacity = '1');
        el.addEventListener('mouseleave', () => hint.style.opacity = '0');
      }
      if (o.action) {
        const fn = typeof o.action === 'function'
          ? () => o.action(this.#state, this.#api())
          : () => { const h = this.#actions.get(o.action); if (h) h(this.#state, this.#api()); };
        el.addEventListener('click', fn);
      }
      this.#sceneEl.appendChild(el);
    }

    #api() {
      return {
        go:     (s) => this.#load(s),
        say:    (l) => this.#dlg.say(l),
        choice: (p, c) => this.#dlg.choice(p, c),
        flash:  (c, ms) => this.#tr.flash(c, ms),
        state:  this.#state,
        reload: () => this.#load(this.#current, true),
      };
    }
  }

  // ════════════════════════════════════════════════════════════════════════════
  //  THE GAME: "THE LAST TRANSMISSION"
  // ════════════════════════════════════════════════════════════════════════════

  const game = new PlanespaceGame({
    container: document.getElementById('game'),
    maxAngle: 6,
    lerpFactor: 0.05,
    perspective: 1100,
    cursorColor: '#c9a84c',
  });

  // ── TITLE SCENE ──────────────────────────────────────────────────────────────
  game.scene('title', {
    layers: [
      { z: -500, className: 'title-bg', style: 'position:absolute;inset:0;' },
      { z: -400, className: 'title-rain' },
      { z: -250, html: '<div class="title-city"></div>' },
      { z: -180, html: '<div class="title-glow"></div>' },
      { z:  -60, html: `
        <div class="title-text">
          <div class="title-eyebrow">A Planespace Narrative</div>
          <div class="title-main">The Last<br>Transmission</div>
          <div class="title-sub">A point &amp; click mystery</div>
        </div>` },
    ],
    objects: [
      {
        z: 40,
        x: '50%', y: '88%',
        html: '<div class="title-prompt">▸ click to begin</div>',
        action: (state, { go }) => go('harbor'),
      }
    ],
  });

  // ── HARBOR SCENE ─────────────────────────────────────────────────────────────
  game.scene('harbor', {
    layers: [
      { z: -500, className: 'harbor-sky' },
      { z: -460, className: 'harbor-rain' },
      { z: -380, html: '<div class="moon"></div>' },
      { z: -320, html: '<div class="moon-clouds"></div>' },
      { z: -240, html: '<div class="city-far"></div><div class="city-lights-far"></div>' },
      { z: -120, html: '<div class="water"><div class="water-reflection"></div></div>' },
      { z:  -80, html: '<div class="dock"></div><div class="dock-posts"><div class="dock-post"></div><div class="dock-post"></div><div class="dock-post"></div></div>' },
      { z:  -40, html: '<div class="lamp-post"><div class="lamp-pole"></div><div class="lamp-head"><div class="lamp-glow"></div></div></div>' },
      { z:  -20, html: `
        <div class="ship">
          <div class="ship-chimney"></div>
          <div class="ship-cabin">
            <div class="ship-window ship-window-1"></div>
            <div class="ship-window ship-window-2"></div>
          </div>
          <div class="ship-hull"></div>
        </div>` },
    ],
    objects: [
      {
        id: 'lamp',
        z: -40, x: '27%', y: '52%',
        label: 'Street lamp',
        html: '',
        style: 'width:50px;height:100px;',
        action: 'examine-lamp',
      },
      {
        id: 'ship-board',
        z: 20, x: '72%', y: '58%',
        label: 'Board the vessel',
        html: `<div style="
          width: 120px; height: 80px;
          border-radius: 6px;
          border: 1px solid rgba(200,160,60,.3);
          background: rgba(200,160,60,.04);
          display: flex; align-items: center; justify-content: center;
          font-family: 'JetBrains Mono', monospace;
          font-size: .62rem; letter-spacing: .1em;
          color: rgba(200,160,60,.5); text-transform: uppercase;
          transition: all .2s;
        " class="item-glow">Enter</div>`,
        action: 'board-ship',
      },
    ],
    onEnter: async (state, { say }) => {
      await say([
        { text: 'Rain. The docks. Same as every night in this city — wet, empty, and smelling of diesel and regret.' },
        { speaker: 'Radio dispatch', text: 'We\'ve been tracking a rogue signal from somewhere in the harbor. Frequency matches old military encryption. Find it. Shut it down.' },
        { text: 'Somewhere across the dark water, a vessel sits with its lights on.' },
      ]);
    },
  });

  game.action('examine-lamp', async (state, { say }) => {
    await say([
      { text: 'A rusted lamp post. Someone\'s scratched a number into the paint: 4-4-7.' },
      { text: 'You make a note of it.' },
    ]);
    state.set('hasCode', true);
  });

  game.action('board-ship', async (state, { say, go }) => {
    await say([
      { text: 'The gangplank groans under your weight. Below, the cabin lights are on.' },
      { speaker: 'You', text: 'Someone\'s been here recently.' },
    ]);
    go('cabin');
  });

  // ── CABIN SCENE ──────────────────────────────────────────────────────────────
  game.scene('cabin', {
    layers: [
      { z: -400, className: 'cabin-walls' },
      { z: -380, className: 'cabin-wall-texture' },
      { z: -300, html: `
        <div class="porthole">
          <div class="porthole-view">
            <div class="porthole-rain"></div>
          </div>
        </div>` },
      { z: -200, html: '<div class="cabin-table"></div><div class="floor-boards"></div>' },
      { z: -160, html: '<div class="cabin-table-edge"></div>' },
      { z:  -80, html: `
        <div class="overhead-lamp">
          <div class="lamp-wire"></div>
          <div class="lamp-shade"></div>
          <div class="lamp-cone"></div>
        </div>` },
      { z:  -40, html: `
        <div class="radio item-glow" style="position:absolute;bottom:22%;right:22%">
          <div class="radio-dial"></div>
          <div class="radio-screen"></div>
          <div class="radio-speaker"></div>
        </div>
        <div class="log-book"></div>
        <div class="map-paper"></div>` },
    ],
    objects: [
      {
        id: 'radio-obj',
        z: 30, x: '76%', y: '70%',
        label: 'Examine radio',
        style: 'width:90px;height:65px;',
        html: '',
        action: 'examine-radio',
      },
      {
        id: 'log-book-obj',
        z: 20, x: '60%', y: '67%',
        label: 'Read log book',
        style: 'width:110px;height:80px;',
        html: '',
        action: 'examine-log',
      },
      {
        id: 'map-obj',
        z: 20, x: '66%', y: '50%',
        label: 'Examine map',
        style: 'width:150px;height:110px;',
        html: '',
        action: 'examine-map',
      },
      {
        id: 'hatch',
        z: 50, x: '50%', y: '88%',
        label: 'Descend to radio room',
        html: `<div style="
          font-family:'JetBrains Mono',monospace;font-size:.62rem;
          letter-spacing:.1em;text-transform:uppercase;
          color:rgba(200,160,60,.4);border:1px solid rgba(200,160,60,.2);
          padding:5px 14px;border-radius:3px;
          background:rgba(200,160,60,.03);
          transition:all .2s;" class="item-glow">▼ Descend</div>`,
        condition: (state) => state.has('readLog'),
        action: 'descend',
      },
    ],
    onEnter: async (state, { say }) => {
      await say([
        { text: 'The cabin is cramped. Tobacco smoke and machine oil. Someone left in a hurry.' },
        { text: 'A radio set hums on the desk. A logbook lies open. A map is pinned to the wall.' },
      ]);
    },
  });

  game.action('examine-radio', async (state, { say }) => {
    await say([
      { speaker: 'You', text: 'Old military surplus hardware. Modified. Someone\'s been broadcasting on a restricted frequency.' },
      { text: 'The dial is locked to a specific channel. You\'ll need to enter a code to change it.' },
    ]);
    state.set('examinedRadio', true);
  });

  game.action('examine-log', async (state, { say, reload }) => {
    await say([
      { speaker: 'Ship\'s Log — Final Entry', text: '"Instructions received. Begin transmission 22:00. Do not deviate from signal. The code is the lamp post number, reversed."' },
      { text: 'The lamp post. 4-4-7. Reversed...' },
      { speaker: 'You', text: '7-4-4. That\'s the code.' },
    ]);
    state.set('readLog', true);
    state.set('codeWord', '744');
    await reload();
  });

  game.action('examine-map', async (state, { say }) => {
    if (!state.has('readLog')) {
      await say([{ text: 'A nautical chart. Coordinates are marked, but they mean nothing without context.' }]);
    } else {
      await say([
        { text: 'The marked coordinates — they point to a receiver station three miles offshore.' },
        { speaker: 'You', text: 'Someone on shore is waiting for this signal. I need to shut down the transmitter first.' },
      ]);
    }
  });

  game.action('descend', async (state, { say, go }) => {
    await say([
      { text: 'A metal hatch. Below, you can hear the hum of electronics.' },
      { speaker: 'You', text: 'The transmitter.' },
    ]);
    go('radioroom');
  });

  // ── RADIO ROOM SCENE ─────────────────────────────────────────────────────────
  game.scene('radioroom', {
    layers: [
      { z: -400, className: 'radioroom-walls' },
      { z: -320, html: '<div class="console-back"></div>' },
      { z: -200, html: `
        <div class="console-panels">
          <div class="console-panel"><div class="panel-indicator ind-red"></div><div class="panel-label">Power</div><div class="panel-knob"></div></div>
          <div class="console-panel"><div class="panel-indicator ind-green"></div><div class="panel-label">Signal</div><div class="panel-knob"></div></div>
          <div class="console-panel"><div class="panel-indicator ind-amber"></div><div class="panel-label">Freq</div><div class="panel-knob"></div></div>
          <div class="console-panel"><div class="panel-indicator ind-blue"></div><div class="panel-label">Encode</div><div class="panel-knob"></div></div>
        </div>` },
      { z:  -80, html: `
        <div class="main-transmitter">
          <div class="transmitter-screen">
            <div class="screen-scan"></div>
            <div class="screen-data">SIGNAL: ACTIVE<br>FREQ: 447.0 MHz<br>MODE: BROADCAST<br>DEST: CLASSIFIED</div>
          </div>
          <div class="transmitter-dials">
            <div class="big-dial"></div>
            <div class="big-dial"></div>
            <div class="big-dial"></div>
          </div>
          <div class="frequency-bar">
            ${Array(12).fill(0).map((_,i) => `<div class="freq-bar" style="animation-delay:${i*0.1}s;height:${4+Math.floor(Math.random()*14)}px"></div>`).join('')}
          </div>
        </div>` },
      { z:  -60, html: '<div class="floor-glow"></div>' },
      { z:  -40, html: `
        <div class="exit-ladder" style="position:absolute;bottom:20%;right:8%">
          <div class="ladder-rail ladder-rail-l"></div>
          <div class="ladder-rail ladder-rail-r"></div>
          <div class="ladder-rung" style="bottom:20px"></div>
          <div class="ladder-rung" style="bottom:50px"></div>
          <div class="ladder-rung" style="bottom:80px"></div>
          <div class="ladder-rung" style="bottom:110px"></div>
        </div>` },
    ],
    objects: [
      {
        id: 'transmitter',
        z: 60, x: '50%', y: '32%',
        label: 'Access transmitter',
        style: 'width:240px;height:160px;',
        html: '',
        action: 'access-transmitter',
      },
      {
        id: 'back-ladder',
        z: 20, x: '92%', y: '78%',
        label: 'Back to cabin',
        style: 'width:50px;height:130px;',
        html: '',
        action: (state, { go }) => go('cabin'),
      },
    ],
    onEnter: async (state, { say }) => {
      await say([
        { text: 'The room is alive with sound — fans, hum, the crackle of an open channel.' },
        { text: 'The transmitter dominates the far wall. It\'s broadcasting. Right now.' },
        { speaker: 'You', text: 'Code 7-4-4. Let\'s end this.' },
      ]);
    },
  });

  game.action('access-transmitter', async (state, { say, choice, flash, go }) => {
    const code = await choice(
      'A keypad glows on the transmitter panel. Enter the shutdown code.',
      [
        { text: '7-4-4  — The reversed lamp post number', value: 'correct' },
        { text: '4-4-7  — The lamp post number', value: 'wrong1' },
        { text: '4-7-4  — A guess', value: 'wrong2' },
      ]
    );

    if (code === 'correct') {
      await flash('#00ff88', 180);
      await say([
        { speaker: 'System', text: 'CODE ACCEPTED. SHUTDOWN INITIATED.' },
        { text: 'The hum drops. The indicators go dark one by one. The signal dies.' },
        { speaker: 'You', text: 'Whatever they were trying to reach — they won\'t find it tonight.' },
        { text: 'Outside, the rain continues. It always does in this city.' },
        { text: 'But for once, something stopped.' },
      ]);
      go('end');
    } else {
      await flash('#ff4444', 80);
      await say([
        { speaker: 'System', text: 'CODE REJECTED.' },
        { speaker: 'You', text: 'Wrong. Think. The log said reversed...' },
      ]);
    }
  });

  // ── END SCENE ─────────────────────────────────────────────────────────────────
  game.scene('end', {
    layers: [
      { z: -500, className: 'end-bg' },
      { z: -400, className: 'end-stars' },
      { z:    0, html: `
        <div class="end-text">
          <div class="end-title">"The signal is dead."</div>
          <div class="end-sub">The Last Transmission — complete</div>
          <div class="end-restart" id="restart-btn">▸ Play Again</div>
        </div>` },
    ],
    onEnter: async (state, { go }) => {
      document.getElementById('restart-btn')?.addEventListener('click', () => go('title'));
    },
  });

  // ── START ─────────────────────────────────────────────────────────────────────
  game.start('title');

  </script>
</body>
</html>
